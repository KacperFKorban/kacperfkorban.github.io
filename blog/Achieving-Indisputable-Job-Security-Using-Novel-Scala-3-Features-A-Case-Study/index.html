<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="korban.dev RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="korban.dev Atom Feed"><title data-react-helmet="true">Achieving Indisputable Job Security Using Novel Scala 3 Features: A Case Study | korban.dev</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kacperfkorban.github.io/blog/Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Achieving Indisputable Job Security Using Novel Scala 3 Features: A Case Study | korban.dev"><meta data-react-helmet="true" name="description" content="Disclaimer"><meta data-react-helmet="true" property="og:description" content="Disclaimer"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-02-14T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/KacperFKorban"><meta data-react-helmet="true" property="article:tag" content="scala,scala 3"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kacperfkorban.github.io/blog/Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study"><link data-react-helmet="true" rel="alternate" href="https://kacperfkorban.github.io/blog/Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kacperfkorban.github.io/blog/Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d05c7c29.css">
<link rel="preload" href="/assets/js/runtime~main.0de25d61.js" as="script">
<link rel="preload" href="/assets/js/main.bb8a9f9b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">korban.dev</b></a><a class="navbar__item navbar__link" href="/aboutme">About Me</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/KacperFKorban" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/Data Modeling in Scala 3, but I only use types">Data Modeling in Scala 3, but I only use types</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study">Achieving Indisputable Job Security Using Novel Scala 3 Features: A Case Study</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/TASTY-way-of-rewriting-macros-in-Scala-3">TASTY way of (re)writing macros in Scala 3</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/How-to-write-Hoogle-for-Kotlin-in-Scala-and-Scala-js">How to write Hoogle for Kotlin in Scala (and Scala.js)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Achieving Indisputable Job Security Using Novel Scala 3 Features: A Case Study</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-02-14T00:00:00.000Z" itemprop="datePublished">February 14, 2022</time> ¬∑ <!-- -->11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/KacperFKorban" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://avatars.githubusercontent.com/u/39772805?v=4" alt="Kacper Korban"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/KacperFKorban" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kacper Korban</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="disclaimer">Disclaimer<a class="hash-link" href="#disclaimer" title="Direct link to heading">‚Äã</a></h2><p>Most of the article is to be perceived as a joke or satire.
The post is intended as a light read. If you manage to get any educational value from it, you will most likely also enjoy reading the ingredients list of 2% milk.
Enjoy!</p><header><h1>Intro</h1></header><p>We computer programmers frequently state that we code because it is our passion, or because we enjoy building things, or for some other fanciful reason. At the end of the day, though, all Software Engineers write code to make money. This has been on my mind quite a bit lately. So I did some market research and analysis, and after crunching all the figures, I put my findings into this graphic.</p><p><img src="/assets/images/image2-1eaf251f06fe8756ec822d72940326b9.png"></p><p>There it is plain and simple. You can clearly see that having a job has a huge impact on the amount of money you make. This is where Scala 3 comes in. We will employ Scala 3 to ensure complete job security. How are we going to do that? It‚Äôs easy! By making the code impossible to read. If no one else can maintain, let alone read, our code, we will never get fired!
In this article, I will use the most straightforward programming problems like ‚ÄúHello World‚Äù or ‚ÄúisPrime‚Äù to demonstrate how you can master this essential skill.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="running-the-examples">Running the examples<a class="hash-link" href="#running-the-examples" title="Direct link to heading">‚Äã</a></h3><p>This might be a good time to say that since all the snippets in this blog post are GitHub Gists, you can run them using <a href="https://scala-cli.virtuslab.org/" target="_blank" rel="noopener noreferrer">scala-cli</a> easily, using the command below.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; scala-cli run gist-url</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="hello-world">Hello World<a class="hash-link" href="#hello-world" title="Direct link to heading">‚Äã</a></h2><p>Ok, let‚Äôs start with the best-known coding ‚Äúproblem‚Äù i.e. ‚ÄúHello World‚Äù. In Scala 3, the solution to this problem usually looks like this:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(&quot;Hello World&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-good-stuff">The good stuff<a class="hash-link" href="#the-good-stuff" title="Direct link to heading">‚Äã</a></h3><p>How do we make this simple code unreadable? Well, instead of writing the code explicitly, we can generate the code that prints the output? Sounds promising! After all, generating code isn&#x27;t easy, right?</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import scala.quoted.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inline def helloWorld =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${ helloWorldImpl }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def helloWorldImpl(using Quotes): Expr[Unit] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{ println(&quot;Hello World&quot;) }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Well, it turns out that it‚Äôs really straightforward. We just add an inline method that calls an actual implementation. And the actual implementation is the quoted code from our previous solution.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="abstract-tree">Abstract tree<a class="hash-link" href="#abstract-tree" title="Direct link to heading">‚Äã</a></h3><p>We&#x27;ve hit a minor obstacle. How can we get around it?
The biggest problem with our implementation is that what was generated is very obvious as we just quoted our code and spliced it.
How about we disallow quoted blocks then? That way, the generated code will be way more obscure.
Exactly what do we need to do here? First, we need to return something that is of type <code>Expr[Unit]</code> and is semantically equivalent to <code>{ println(&quot;Hello World&quot;) }</code>.
The main ways to construct <code>Expr</code> are using helper functions in its companion object or creating an (Abstract syntax) <code>Tree</code> and converting it to an <code>Expr</code>.</p><p>Yeah, right, <code>Expr&#x27;s and </code>Tree&#x27;s, we don&#x27;t really care about the semantics. We know that our expression should be the same as quoted <code>println(&quot;Hello World&quot;)</code>. So, let&#x27;s do what software developers usually do: put a bunch of `println&#x27;s in random places and hope for the best.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def helloWorldImpl(using Quotes): Expr[Unit] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(&#x27;{ println(&quot;Hello World&quot;) }.asTerm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{ () }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After running it, at compile time we get:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">Inlined(Ident(helloworldMacro$package$),List(),Apply(Ident(println),List(Literal(Constant(Hello World)))))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We can ignore the <code>Inlined</code> because it means that the term we got was an inlined expression. The exciting part is:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">Apply(Ident(println),List(Literal(Constant(Hello World))))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>So it‚Äôs an <code>Apply</code> which is a function application of <code>Ident(println)</code> to <code>List(Literal(Constant(Hello World)))</code>. Great, let‚Äôs try recreating it using Quotes API. So, let‚Äôs construct an <code>Apply</code>, along with ‚ÄòSomething‚Äô as the first argument and a list containing a string literal as the second:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private def helloWorldImpl(using Quotes): Expr[Unit] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import quotes.reflect.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val tree = Apply(???, List(Literal(StringConstant(&quot;Hello World&quot;))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tree.asExprOf[Unit]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It&#x27;s a good start, but what about the <code>???</code>? Well‚Ä¶ it has to be the reference of <code>println</code> and from the definition of <code>ApplyModule.apply</code>, it has to be a <code>Term</code>. From this, we can imply that what we are looking for is most likely <code>Ref</code>, which requires a Symbol.</p><p>The Symbol object has methods with a naming pattern beginning with <code>required</code>, for example: <code>requiredClass</code>, <code>requiredMethod</code>, <code>requiredModule</code>, <code>requiredPackage</code> and so on. Those methods let us &#x27;summon&#x27; symbols of a specific type defined in the compilation unit or on the classpath. Seems great since we want a static method, right? Let&#x27;s try.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private def helloWorldImpl(using Quotes): Expr[Unit] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import quotes.reflect.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val prntln: Ref =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Symbol.requiredMethod(&quot;scala.Predef.println&quot;).pipe(Ref(_))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val tree = Apply(prntln, List(Literal(StringConstant(&quot;Hello world&quot;))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tree.asExprOf[Unit]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Note: We use <code>pipe</code> here, a function from <code>scala.util.chaining</code>. Although the actual implementation is slightly different, it can be thought of like so:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">extension [A](a: A)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def pipe[B](f: A =&gt; B): B = f(a)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you see a similarity with <code>|</code> bash, then you‚Äôre absolutely right. That‚Äôs one of the inspirations for it. And If you see a resemblance with <code>$</code> or <code>&amp;</code> from Haskell, then you should go out more often.</p><p>Right, we can now run it.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[error] ./main.scala:31:3: Exception occurred while executing macro expansion.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error] dotty.tools.dotc.core.TypeError: Failure to disambiguate overloaded reference with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]   method println in object Predef: (x: Any): Unit  and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]   method println in object Predef: (): Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at dotty.tools.dotc.core.Denotations$MultiDenotation.suchThat(Denotations.scala:1244)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at dotty.tools.dotc.core.Denotations$Denotation.requiredSymbol(Denotations.scala:297)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at dotty.tools.dotc.core.Symbols$.requiredMethod(Symbols.scala:908)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at scala.quoted.runtime.impl.QuotesImpl$reflect$Symbol$.requiredMethod(QuotesImpl.scala:2450)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at scala.quoted.runtime.impl.QuotesImpl$reflect$Symbol$.requiredMethod(QuotesImpl.scala:2450)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at tmp.tmp$package$.helloWorldImpl(tmp.scala:12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[error]     at tmp.tmp$package$.inline$helloWorldImpl(tmp.scala:9)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Cool, we got some good old-fashioned compiler error, with many references to compiler internals in the stack trace. That‚Äôs what we wanted to see.
Well, except that after skipping the first line, the message is actually pretty reasonable. There simply are two functions named <code>println</code> at this path. And the scaladoc confirms it:</p><p><img src="/assets/images/image1-8ef6b297427f9d9fa5bd6762e6e323f3.png"></p><p>That means that we cannot solve the problem that easily. But that‚Äôs good. The more code, the less readable it becomes. If we cannot access the method itself, let‚Äôs access the owner first and get the method from the list of its members. The way we do that is:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">Symbol.required(&quot;scala.Predef&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Get its member methods named ‚Äòprintln‚Äô...</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  .memberMethod(&quot;println&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Then filter out the methods with no arguments‚Ä¶</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  .flatMap { m =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m.tree match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case defdef: DefDef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if !defdef.paramss.flatMap(_.params).isEmpty =&gt; Some(m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case _ =&gt; None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>And finally, just take the <code>head</code> of the list and wrap it in <code>Ref</code>...</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  .head.pipe(Ref(_))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Cool. So, after composing it into our previous template, we get:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private def helloWorldImpl(using Quotes): Expr[Unit] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import quotes.reflect.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val prntln = Symbol.requiredPackage(&quot;scala.Predef&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .memberMethod(&quot;println&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .flatMap { m =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      m.tree match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case defdef: DefDef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if !defdef.paramss.flatMap(_.params).isEmpty =&gt; Some(m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case _ =&gt; None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }.head.pipe(Ref(_))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val tree = Apply(prntln, List(Literal(StringConstant(&quot;Hello world&quot;))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tree.asExprOf[Unit]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>And testing it gives us‚Ä¶</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; scala-cli run ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello World</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Great! And just like that, we were able to utilize metaprogramming to write confusing and unmaintainable code.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="not-so-simple-algebra">Not so simple algebra<a class="hash-link" href="#not-so-simple-algebra" title="Direct link to heading">‚Äã</a></h2><p>Since we&#x27;ve already done quite a few Hello-Worlds. Let&#x27;s change things up a bit now. Several well-known problems are usually used to learn recursion, e.g. the Fibonacci sequence, factorial, greatest common divisor, is prime, etc. Let&#x27;s pick one at random; let&#x27;s choose is prime.</p><p>Now you may start asking yourself: &quot;How can I really be sure that it&#x27;s actually at random?&quot;.
And my answer to you would be: &quot;My blog post, my rules. So if I say that it&#x27;s random, then it&#x27;s random, ok?&quot;</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="vanilla">Vanilla<a class="hash-link" href="#vanilla" title="Direct link to heading">‚Äã</a></h3><p>Let‚Äôs implement the standard version as a warm-up.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def isPrimeCheat(a: Int): Boolean =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2.until(a).forall(a % _ != 0)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Looks okay, right? RIGHT?! Of course not. I mean‚Ä¶ it correctly checks if a number is prime, I‚Äôll give you that. But we said that it‚Äôs an exercise for recursion. And do you see any recursion here? Let‚Äôs fix it then.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def isPrime(a: Int, acc: Int = 2): Boolean =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if a &lt;= acc then a == acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else a % acc != 0 &amp;&amp; isPrime(a, acc+1)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>See? It looks better now.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="no-value-calculations">No value calculations<a class="hash-link" href="#no-value-calculations" title="Direct link to heading">‚Äã</a></h3><p>Now that the warm-up is over, how do we make this unreadable? How about disallowing the use of values? Sounds great, but can we make it work?
The answer is obviously yes; we can use types.
Scala 3 has a pretty impressive type system that can operate on singleton types. We can say that the type of <code>1</code> is <code>1</code> and <code>1</code> is a subtype of <code>Int</code>. Cool right?
We also know that there is a pretty comprehensive set of type families (functions on type-level) that let us operate on singleton types. This means that we can almost rewrite our standard implementation 1:1. A reasonable attempt will look like this:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import scala.compiletime.ops.int.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type IsPrime[A &lt;: Int] = IsPrimeRec[A, 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type IsPrimeRec[A &lt;: Int, B &lt;: Int] &lt;: Boolean = A &lt;= B match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case true =&gt; A == B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case false =&gt; A % B != 0 &amp;&amp; IsPrimeRec[A, S[B]]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>First of all, we cannot have default parameters, so we will have to create a proxy function that calls our actual implementation. Then when we look at the actual definition, it is really similar to what we wrote on the value level. The only difference is that we used a match instead of an if statement. And that‚Äôs because Scala has match types, but there is no such thing as if-else types.</p><p>You might be thinking now: ‚ÄúHold on a sec. How are we going to print the result if it‚Äôs a type?‚Äù.
First of all: Ok, smarty-pants. And secondly, we can use the function <code>constValue</code> from <code>scala.compiletime</code>, which lets us summon values of a given type if the type has a single decidable inhabitant. Like so:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import scala.compiletime.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def main =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(constValue[IsPrime[13]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(constValue[IsPrime[12]])</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>So when we run it, we get:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; scala-cli run ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Success!</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="manual-labor">Manual labor<a class="hash-link" href="#manual-labor" title="Direct link to heading">‚Äã</a></h3><p>What did we learn from our exercise just now? Scala 3 makes type-level programming (at least for chosen types) way too easy. Mainly, that&#x27;s because there are so many util functions. That&#x27;s right, you know what&#x27;s coming. Let‚Äôs limit our usage of functions from <code>scala.compiletime.ops.int</code> to just <code>S</code>.
If you don&#x27;t know what <code>S</code> does, let me explain. It&#x27;s a type-level successor function for integers. So e.g. S<!-- -->[0]<!-- --> = 1, S<!-- -->[1]<!-- --> = 2 and so on.
And why did we choose <code>S</code> in the first place? That&#x27;s because, together with the literal <code>0</code>, it works just like the definition of an inductive set for natural numbers. And since all of our operations are only required to work on natural numbers, we&#x27;re going to implement them that way, so it&#x27;s undefined behaviour for negative numbers.</p><p>Since the only thing that has to change is the declarations of the helper function, the actual implementation can stay as it was.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">type IsPrimeRec[A &lt;: Int, B &lt;: Int] &lt;: Boolean = A &lt;= B match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case true =&gt; A == B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case false =&gt; A % B != 0 &amp;&amp; IsPrimeRec[A, S[B]]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>What function do we need to implement first? Looks like it‚Äôs going to be <code>&lt;=</code>. Since we are implementing it for natural numbers, it seems obvious that the implementation has to follow their inductive definition.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">type &lt;=[A &lt;: Int, B &lt;: Int] &lt;: Boolean = A match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case 0 =&gt; true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case S[a] =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    B match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case 0 =&gt; false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case S[b] =&gt; a &lt;= b</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It&#x27;s pretty simple:</p><ul><li>if <code>A</code> is zero then it is smaller or equal to any natural number</li><li>otherwise <code>A</code> is a successor of any <code>a</code>, so:<ul><li>if <code>B</code> is zero then it cannot be larger or equal than <code>S[a]</code></li><li>otherwise <code>B</code> is a successor of any <code>b</code> and we check if their predecessors satisfy the predicate.</li></ul></li></ul><p>Let&#x27;s do the % next. This one is also pretty simple and looks like this:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">type %[A &lt;: Int, B &lt;: Int] &lt;: Int = A &lt; B match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case true =&gt; A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case _ =&gt; (A - B) % B</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Nothing exciting going on here. If A is smaller than B, just return B; otherwise, return (A-B) % B.</p><p>The rest of the functions are left as an exercise for the reader, but let‚Äôs check if it works?</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; scala-cli run ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="conclusions">Conclusions<a class="hash-link" href="#conclusions" title="Direct link to heading">‚Äã</a></h2><p>So, what did we learn from this article? Mainly that, in Scala 3, even code that&#x27;s meant to be complicated isn&#x27;t actually that bad. And writing unreadable code requires some skill.</p><p>So, why not use some of the languages that are unmaintainable by definition, like Rust or Python?
In the case of Rust, it is pretty easy: nobody actually uses Rust; people just like talking about using Rust.
And when it comes to Python, the problem is that every program in Python is unmaintainable, and we wanted to write code that is readable only to us.</p><p>Medium link: <a href="https://medium.com/virtuslab/achieving-indisputable-job-security-using-novel-scala-3-features-a-case-study-65180eab810a" target="_blank" rel="noopener noreferrer">https://medium.com/virtuslab/achieving-indisputable-job-security-using-novel-scala-3-features-a-case-study-65180eab810a</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/scala">scala</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/scala-3">scala 3</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/KacperFKorban/kacperfkorban.github.io/blog/2022-02-14-Achieving-Indisputable-Job-Security-Using-Novel-Scala-3-Features-A-Case-Study.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/Data Modeling in Scala 3, but I only use types"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ <!-- -->Data Modeling in Scala 3, but I only use types</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/TASTY-way-of-rewriting-macros-in-Scala-3"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">TASTY way of (re)writing macros in Scala 3<!-- --> ¬ª</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#disclaimer" class="table-of-contents__link toc-highlight">Disclaimer</a><ul><li><a href="#running-the-examples" class="table-of-contents__link toc-highlight">Running the examples</a></li></ul></li><li><a href="#hello-world" class="table-of-contents__link toc-highlight">Hello World</a><ul><li><a href="#the-good-stuff" class="table-of-contents__link toc-highlight">The good stuff</a></li><li><a href="#abstract-tree" class="table-of-contents__link toc-highlight">Abstract tree</a></li></ul></li><li><a href="#not-so-simple-algebra" class="table-of-contents__link toc-highlight">Not so simple algebra</a><ul><li><a href="#vanilla" class="table-of-contents__link toc-highlight">Vanilla</a></li><li><a href="#no-value-calculations" class="table-of-contents__link toc-highlight">No value calculations</a></li><li><a href="#manual-labor" class="table-of-contents__link toc-highlight">Manual labor</a></li></ul></li><li><a href="#conclusions" class="table-of-contents__link toc-highlight">Conclusions</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Content</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social media</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/KacperKorban" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/KacperFKorban" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 korban.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0de25d61.js"></script>
<script src="/assets/js/main.bb8a9f9b.js"></script>
</body>
</html>